<?php

namespace Platformd\UserBundle\Entity;

use Doctrine\ORM\EntityRepository;
use Doctrine\ORM\AbstractQuery;
use Doctrine\ORM\QueryBuilder;
use DateTime;

/**
 * UserRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class UserRepository extends EntityRepository
{

	/**
	 * get users that signed for a specificed giveaway key
	 * 
	 * @param $giveaway_pool = giveaway_key.pool
	 * @param $site = 'en' 
	 */
	public function findAssignedToUser($giveaway_pool, $site)
	{
      $qb =  $this->createSiteQueryBuilder($site)
       // ->select('u.id, u.firstname, u.lastname, u.email, u.system_tag, k.ipAddress, k.assignedAt')
        ->select('u.id, u.firstname, u.lastname, u.email, k.ipAddress, k.assignedAt')
    	->leftJoin('u.giveawayKeys', 'k')
    	->andWhere('u.id = k.user')
    	->andWhere('k.pool = :pool_id')
    	->setParameters(array(
    			'pool_id'  => $giveaway_pool,
    	))
    	->getQuery()
    	->getResult();
      
      return  $qb ;
	}
	
	
	public function getTotalUsersForSite($site)
    {
        return $this->createSiteQueryBuilder($site)
            ->select('COUNT(u.id)')
            ->getQuery()
            ->setMaxResults(1)
            ->getOneOrNullResult(AbstractQuery::HYDRATE_SINGLE_SCALAR)
        ;
    }

    public function getArenaOptInForSite($site)
    {
        $qb = $this->createSiteQueryBuilder($site);

        return $this->addArenaOptQuery($qb, true)
            ->select('COUNT(u.id)')
            ->getQuery()
            ->setMaxResults(1)
            ->getOneOrNullResult(AbstractQuery::HYDRATE_SINGLE_SCALAR)
        ;
    }

    public function getDellOptInForSite($site)
    {
        $qb = $this->createSiteQueryBuilder($site);

        return $this->addDellOptQuery($qb, true)
            ->select('COUNT(u.id)')
            ->getQuery()
            ->setMaxResults(1)
            ->getOneOrNullResult(AbstractQuery::HYDRATE_SINGLE_SCALAR)
        ;
    }

    /**
     * Returns the number of new users since the given DateTime
     *
     * @param \DateTime $since
     * @return integer
     */
    public function countNewRegistrants(DateTime $since = null, $site)
    {
        $qb = $this->createSiteQueryBuilder($site);
     
        return $this->addSinceQuery($qb, $since)
            ->select('COUNT(u.id)')
            ->getQuery()
            ->setMaxResults(1)
            ->getOneOrNullResult(AbstractQuery::HYDRATE_SINGLE_SCALAR)
        ;
    }
    
    /**
    * @param \Doctrine\ORM\QueryBuilder $qb
    * @param $since
    * @return \Doctrine\ORM\QueryBuilder
    */
    private function addSinceQuery(QueryBuilder $qb, $since)
    {
        if ($since != null) {
            $qb->andWhere('u.created >= :since')
            ->setParameter('since', $since);
        }
        return $qb;  
    }

    /**
     * @param $site
     * @return \Doctrine\ORM\QueryBuilder
     */
    private function createSiteQueryBuilder($site)
    {
        return $this->createQueryBuilder('u')
            ->andWhere('u.locale = :locale')
            ->setParameter('locale', $site)
        ;
    }

    /**
     * @param \Doctrine\ORM\QueryBuilder $qb
     * @param $optIn
     * @return \Doctrine\ORM\QueryBuilder
     */
    private function addArenaOptQuery(QueryBuilder $qb, $optIn)
    {
        return $qb->andWhere('u.subscribedAlienwareEvents = :optIn')
            ->setParameter('optIn', $optIn)
        ;
    }

    /**
     * @param \Doctrine\ORM\QueryBuilder $qb
     * @param $optIn
     * @return \Doctrine\ORM\QueryBuilder
     */
    private function addDellOptQuery(QueryBuilder $qb, $optIn)
    {
        return $qb->andWhere('u.subscribedGamingNews = :optIn')
            ->setParameter('optIn', $optIn)
        ;
    }
}