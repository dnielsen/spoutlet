{% extends 'SpoutletBundle::adminLayout.html.twig' %}

{% block content %}
<h1>Choose Winner for {{ contest.name }}</h1>

{% if contest.votingEnd | date('Y-m-d H:i:s') < 'now' | date('Y-m-d H:i:s') %}

<p class="alert alert-info help"><i class="icon-info-sign"></i>
    The entries are shown below, sorted by vote count. Please select up to 3 winners.
</p>

<form action="{{ path('admin_contest_confirm_winner', { 'slug' : contest.slug }) }}" method="post" class="form-horizontal">

<table class="table table-striped table-bordered tablesorter">
    <thead>
        <tr>
            <th>Image</th>
            <th>URL</th>
            <th>Username</th>
            <th>Entry Date</th>
            <th>Likes</th>
            <th>Dislikes</th>
            <th>Points</th>
            <th>Country</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>

    {% if entries | length < 1 %}

        <tr>
            <td colspan=6>No entries found!</td>
        </tr>

    {% else %}

        {% for entry in entries %}

            {% set entryLikes = entry.id in likes|keys ? likes[entry.id] : 0 %}
            {% set entryDislikes = entry.id in dislikes|keys ? dislikes[entry.id] : 0 %}
            {% set likesPercentage = entryLikes + entryDislikes > 0 ? entryLikes / (entryLikes + entryDislikes) * 100 : 0 %}
            {% set dislikesPercentage = entryLikes + entryDislikes > 0 ? entryDislikes / (entryLikes + entryDislikes) * 100 : 0 %}

            <tr>
                <td><img src="{{ media_path(entry.image, {'local': true}) | imagine_filter('game_show_logo') }}" alt="{{ entry.title }}" /></td>
                <td><a target="_blank" href="{{ path('gallery_media_show', { 'id' : entry.id }) }}">{{ path('gallery_media_show', { 'id' : entry.id }) }}</a></td>
                <td>{{ entry.author.username }}</td>
                <td>{{ entry.createdAt | date }}</td>
                <td>{{ likesPercentage | number_format }}%</td>
                <td>{{ dislikesPercentage | number_format }}%</td>
                <td>{{ entryLikes - entryDislikes }}</td>
                <td>{{ entry.author.country }}</td>
                <td>
                    <input type="radio" name="first_place" value="{{ entry.id }}"{% if (contest.winners != null) and (contest.winners[0] == entry.id) %} checked=true{% endif %}>1st place<br />
                    <input type="radio" name="second_place" value="{{ entry.id }}"{% if (contest.winners != null) and (contest.winners[1] == entry.id) %} checked=true{% endif %}>2nd place<br />
                    <input type="radio" name="third_place" value="{{ entry.id }}"{% if (contest.winners != null) and (contest.winners[2] == entry.id) %} checked=true{% endif %}>3rd place<br />
                </td>
            </tr>
        {% endfor %}

    {% endif %}

    </tbody>
</table>

<button type="submit" class="btn btn-primary choose-winners" formnovalidate>Submit</button>
<input class="btn btn-primary" type="reset" value="Reset Form" />

{% else %}

<p class="alert alert-info help"><i class="icon-info-sign"></i>
    Voting for this contest has not finished yet. Please either wait for the contest to end or edit the contest so that it has already ended.
</p>

{% endif %}

<script type="text/javascript">
    $(function () {
        $("table").tablesorter({
            sortList: [[6,1]]
        });
    });

    jQuery(function($) {
        $("button.choose-winners").bind("click", function(event) {
            if (!$("input[name='first_place']").is(':checked')) {
                alert("You have not selected a first place entry");
                event.stopPropagation();
                event.preventDefault();

                return false;
            }

            if ($("input[name='first_place']").is(':checked') && $("input[name='third_place']").is(':checked') && !$("input[name='second_place']").is(':checked')) {
                alert("You have selected a third place entry without awarding second place");
                event.stopPropagation();
                event.preventDefault();

                return false;
            }
        })
    });
</script>

{% endblock %}
