<?php

namespace Platformd\IdeaBundle\Entity;

use Doctrine\ORM\EntityRepository;

use Platformd\IdeaBundle\Entity\VoteCriteria;
/**
 * IdeaRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class IdeaRepository extends EntityRepository
{

    /**
     * @param $event
     * @param null $tag
     * Filters idea list by event, current round, optional tag, and isPrivate
     * @return array
     */
    public function filter($eventId, $round, $tag = null, $private = false, $userId = null)
    {
         $qb = $this->createQueryBuilder('i')
            ->select      ('i')
            ->where       ('i.event = :eventId')
            ->andWhere    ('i.highestRound >= :round')
            ->andWhere    ('i.isPrivate = :private')

            ->setParameters(
                 array(
                     'eventId'  => $eventId,
                     'round'    => $round,
                     'private'  => $private,
                 ));

        if ($private and $userId) {
            $qb->andWhere ('i.creator = :userId');
            $qb->setParameter('userId', $userId);
        }

		if(!is_null($tag) && $tag <> '') {
			$qb->innerJoin('i.tags', 't', 'WITH', 't.tagName = :tag')->setParameter('tag', $tag);
		}

		return $qb->getQuery()->getResult();
	}

    private function createCsvString($data) {
        // Open temp file pointer
        if (!$fp = fopen('php://temp', 'w+')) return FALSE;

        // Loop data and write to file pointer
        foreach ($data as $line) fputcsv($fp, $line);

        // Place stream pointer at beginning
        rewind($fp);

        // Return the data
        return stream_get_contents($fp);
    }

    public function toCSV() {
        $ideasArray = array();

        //Add header
        $headerArray = array(
            "Idea","Event", "Creator", "Title", "Creation Time",
            "Description", "Stage", "For Course", "Professors",
            "Amount", "Members", "HighestRound", "IsPrivate"
        );
        $ideasArray[] = $headerArray;

        foreach($this->findAll() as $idea) {
            $ideaArray = array(
                $idea->getId(),
                $idea->getEvent()->getName(),
                $idea->getCreator()->getUsername(),
                $idea->getName(),
                $idea->getCreatedAt()->format('Y-m-d H:i:s'),
                $idea->getDescription(),
                $idea->getStage(),
                $idea->getForCourse(),
                $idea->getProfessors(),
                $idea->getAmount(),
                $idea->getMembers(),
                $idea->getHighestRound(),
                $idea->getIsPrivate()
            );
            $ideasArray[] = $ideaArray;
        }
        return $this->createCsvString($ideasArray);
    }

	public function sortByVotes(&$ideas, $desc = true, VoteCriteria $criteria = null) {
		usort($ideas, function($a, $b) use ($desc, $criteria) {
			$valueA = $a->getVoteAvg($criteria);
			$valueB = $b->getVoteAvg($criteria);
			if($valueA == $valueB ) { return 0; }

			if($desc)
				return ($valueA < $valueB) ? 1 : -1;
			else
				return ($valueA < $valueB) ? -1 : 1;
		});
		return $ideas;
	}

    public function sortByFollows(&$ideas) {
        usort($ideas, function($a, $b) {
                $valueA = $a->getNumFollowers();
                $valueB = $b->getNumFollowers();
                if($valueA == $valueB )
                    return 0;
                return ($valueA < $valueB) ? 1 : -1;
            });
        return $ideas;
    }

    public function sortByCreatedAt(&$ideas) {
        usort($ideas, function($a, $b) {
                $valueA = $a->getCreatedAt();
                $valueB = $b->getCreatedAt();
                if($valueA == $valueB )
                    return 0;
                return ($valueA < $valueB) ? 1 : -1;
            });
        return $ideas;
    }

}
