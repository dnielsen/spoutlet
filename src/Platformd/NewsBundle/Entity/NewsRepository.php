<?php

namespace Platformd\NewsBundle\Entity;

use Doctrine\ORM\EntityRepository;
use Doctrine\ORM\QueryBuilder;
use Platformd\GameBundle\Entity\Game;
use Platformd\NewsBundle\Entity\News;

/**
 * NewsRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class NewsRepository extends EntityRepository
{
    /**
     * Used in the admin
     *
     * @return \Doctrine\ORM\Query
     */
    public function getFindNewsQuery()
    {
        return $this->createQueryBuilder('n')
            ->addOrderBy('n.postedAt', 'DESC')
            ->addOrderBy('n.id', 'DESC')
            ->getQuery();
    }

    public function getFindNewsForSiteQuery($site)
    {
        return $this->createQueryBuilder('n')
            ->leftJoin('n.sites', 's')
            ->andWhere(is_string($site) ? 's.name = :site' : 's = :site')
            ->setParameter('site', $site)
            ->addOrderBy('n.postedAt', 'DESC')
            ->addOrderBy('n.id', 'DESC')
            ->getQuery();
    }

    public function findAllForSite($site)
    {
        return $this->createBaseQueryBuilder($site)
            ->addOrderBy('n.postedAt', 'DESC')
            ->addOrderBy('n.id', 'DESC')
            ->getQuery()
            ->getResult()
        ;
    }

    public function findMostRecentArticleForSite($site)
    {
        return $this->createBaseQueryBuilder($site)
            ->andWhere('n.type = :article')
            ->addOrderBy('n.postedAt', 'DESC')
            ->addOrderBy('n.id', 'DESC')
            ->setParameter('article', News::NEWS_TYPE_ARTICLE)
            ->getQuery()
            ->setMaxResults(1)
            ->getOneOrNullResult()
        ;
    }

    /**
     * @param $num
     * @return \Platformd\NewsBundle\Entity\News[]
     */
    public function findMostRecentForSite($site, $num)
    {
        return $this->createBaseQueryBuilder($site)
            ->addOrderBy('n.postedAt', 'DESC')
            ->addOrderBy('n.id', 'DESC')
            ->getQuery()
            ->setMaxResults($num)
            ->execute()
        ;
    }

    public function findMostRecentForSiteExcept($site, $num, $exceptId)
    {
        $qb =  $this->createBaseQueryBuilder($site)
            ->addOrderBy('n.postedAt', 'DESC')
            ->addOrderBy('n.id', 'DESC');

        if ($exceptId) {
            $qb->andWhere('n.id <> :exceptId')
            ->setParameter('exceptId', $exceptId);
        }

        return $qb->getQuery()
            ->setMaxResults($num)
            ->execute()
        ;
    }

    /**
     * @param Game $game
     * @return \Platformd\NewsBundle\Entity\News[]
     */
    public function findActivesForGame(Game $game, $site)
    {
        return $this->createBaseQueryBuilder($site)
            ->andWhere('n.game = :game')
            ->setParameter('game', $game)
            ->addOrderBy('n.postedAt', 'DESC')
            ->addOrderBy('n.id', 'DESC')
            ->getQuery()
            ->execute()
        ;
    }

    /**
     * Creates a base query builder that's locale-aware and only returns
     * published entries
     * @param \Doctrine\ORM\QueryBuilder|null $qb
     * @return \Doctrine\ORM\QueryBuilder|null
     */
    protected function createBaseQueryBuilder($site, QueryBuilder $qb = null)
    {
        if ($qb === null) {
            $qb = $this->createQueryBuilder('n');
        }

        $qb->leftJoin('n.sites', 's')
            ->andWhere('n.published = 1');

        if (is_string($site)) {
            $qb->andWhere('s.name = :site')
                ->setParameter('site', $site);

            return $qb;
        }

        $qb->andWhere('s = :site')
            ->setParameter('site', $site);

        return $qb;
    }
}
