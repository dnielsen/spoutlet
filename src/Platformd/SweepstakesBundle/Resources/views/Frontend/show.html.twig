{% extends 'SpoutletBundle::layout.html.twig' %}

{% block stylesheets %}
    {{ parent() }}

    <link rel="stylesheet" href="{{ asset('bundles/giveaway/css/giveaway.css') }}">
{% endblock %}

{% block title sweepstakes.name %}

{# only use the flash if we have an assigned key #}
{% block flash_type %}{{ assignedEntry ? 'success' : false }}{% endblock %}

{# only really need to populate this if we have an assigned key #}
{% block flash %}
    {% if assignedEntry %}
        <p>
            {{ 'platformd.sweepstakes.entered.message' | trans }}
        </p>
    {% endif %}
{% endblock %}

{% block content %}
    <div id="content">
        <div class="std_1col">

            {% if sweepstakes.bannerImage %}
                <div id="eventHeader" style="background:url('{{ asset(media_path(sweepstakes)) }}') no-repeat;"></div>
            {% endif %}

            <div class="page-header">
                <h1>{{ sweepstakes.name }}</h1>

                {% if sweepstakes.generalImage %}
                    <img src="{{ asset(media_path(sweepstakes, {
                        'type': 'general'
                    })) }}" alt="{{ sweepstakes.name }}" alt="{{ sweepstakes.name }}" />
                {% endif %}
            </div><!-- widget-header -->
        </div><!-- std_1col -->

        <div class="std_2col">
            <div class="right">
                <div id="giveaway-getkey" class="widget-33">
                    <div class="widget-header">
                        <div class="widget-title">{{ 'platformd.sweepstakes.enter' | trans }}</div>
                    </div>

                    <form action="{{ path('sweepstakes_enter', {'slug': sweepstakes.slug}) }}" method="GET" id="sweeps-form-enter">

                        <div class="widget-content">
                            {% if isEntered %}
                                <p>{{ 'already_entered_sweepstakes' | trans }}</p>
                            
                            {% else %}
                                <ol>
                                    {% include 'SweepstakesBundle:Frontend:_defaultSteps.html.twig' with {'sweepstakes': sweepstakes} %}
                                </ol>
    
                                <div class="form-msg-error" id="_sweeps_error"></div>

                                {% if is_granted('IS_AUTHENTICATED_REMEMBERED') %}

                                    <div class="agree-row">
                                        <input type="checkbox" name="_terms" id="_sweepstakes_terms" />
                                        <label for="_sweepstakes_terms">{{ 'read_and_agreed_to_rules' | trans({
                                            '%a_start%': '<a href="#" class="sweeps-terms-modal">',
                                            '%a_end%': '</a>'
                                        }) | raw }}</label>
                                    </div>

                                    <div class="agree-row">
                                        <input type="checkbox" name="_release" id="_sweepstakes_release" />
                                        <label for="_sweepstakes_release">{{ 'agree_sweeps_eligibility' | trans({
                                            '%a_start%': '<a href="#" class="sweeps-release-modal">',
                                            '%a_end%': '</a>'
                                        }) | raw }}</label>
                                    </div>

                                    <div style="text-align: center;">
                                        <input type="submit" value="{{ 'enter' | trans }}" class="button" />
                                    </div>

                                {% endif %}
    
                                <div class="clear"></div>
                            {% endif %}

                        </div>
                    </form>
                </div>

            </div><!-- right -->
            
            <div class="left">
                <div id="giveaway-info" class="widget-66">
                    <div class="widget-header">
                        <div class="widget-title">{{ 'overview' | trans }}</div>
                    </div><!-- widget-header -->

                    <div class="widget-content" id="giveaway-details">
                        <ul class="sweepstakes-details">
                            <li class="tight">
                                <label>{{ 'registration_opens' | trans }}</label>

                                {{ 'sweepstakes_date_format' | trans({
                                    '%year%': sweepstakes.startsAtInTimezone | date('Y'),
                                    '%month%': sweepstakes.startsAtInTimezone | date('m'),
                                    '%day%': sweepstakes.startsAtInTimezone | date('d'),
                                    '%time%': sweepstakes.startsAtInTimezone | date('H:i'),
                                }) }}
                                {{ sweepstakes.timezoneString }}
                            </li>
                            <li>
                                {% if sweepstakes.endsAt %}

                                    <label>{{ 'registration_closes' | trans }}</label>
                                    {{ 'sweepstakes_date_format' | trans({
                                        '%year%': sweepstakes.endsAtInTimezone | date('Y'),
                                        '%month%': sweepstakes.endsAtInTimezone | date('m'),
                                        '%day%': sweepstakes.endsAtInTimezone | date('d'),
                                        '%time%': sweepstakes.endsAtInTimezone | date('H:i'),
                                    }) }}
                                    {{ sweepstakes.timezoneString }}
                                {% else %}
                                    <label>{{ 'registration_closes' | trans }}</label>
                                    {{ 'na' | trans }}
                                {% endif %}
                            </li>
                            <li>
                                <label>{{ 'eligibility' | trans }}</label>
                                <ol class="eligibility-list">
                                    <li>{{ sweepstakes.eligibleCountries | join(', ') }}</li>
                                    <li>
                                        {{ 'age_or_older_as_of_date' | trans({
                                            '%age%': sweepstakes.minimumAgeRequirement,
                                            '%as_of_date%': sweepstakes.startsAtInTimezone | date ('Y-m-d')
                                        })}}
                                    </li>
                                </ol>
                            </li>
                        </ul>

                        <label>{{ 'instructions' |trans }}</label><br/>

                        {{ sweepstakes.content | raw }}

                    </div><!-- giveaway-details -->

                </div><!-- giveaway-info -->
                    {% render "FOSCommentBundle:Thread:showFlat" with {"id": sweepstakes.slug } %}
            </div><!-- left -->
            
            <div class="clear">
            
            </div><!-- clear -->
        </div><!-- std_2col -->
    </div>

    <div id="sweeps-terms-modal-content" class="modal-content" style="display: none">
        <h3>{{ 'official_sweepstakes_rules' | trans }}</h3>
        {{ sweepstakes.officialRules | raw }}
    </div>

    <div id="sweeps-release-modal-content" class="modal-content" style="display: none">
        <h3>{{ 'official_sweepstakes_release' | trans }}</h3>
        {{ sweepstakes.officialRules | raw }}
    </div>

    <script type="text/javascript">
        window.Sweeps = {
            renderError: function(msg) {

                $('#_sweeps_error').html(msg).show();
            }
        };

        jQuery(document).ready(function() {
            // make the terms content display in a modal
            $('.sweeps-terms-modal').click(function() {
                $.modal($('#sweeps-terms-modal-content'), {
                    overlayClose: true
                });

                return false;
            });

            // make the release content display in a modal
            $('.sweeps-release-modal').click(function() {
                $.modal($('#sweeps-release-modal-content'));

                return false;
            });

            // on submit of the form, make sure that both of the checkboxes are checked
            $('#sweeps-form-enter').submit(function() {
                if (
                    !$('#_sweepstakes_terms').is(':checked')
                    || !$('#_sweepstakes_release').is(':checked')
                    ) {
                    Sweeps.renderError('{{ 'sweeps_check_both_boxes' | trans }}');

                    return false;
                }

                return true;
            });
        });
    </script>
{% endblock %}