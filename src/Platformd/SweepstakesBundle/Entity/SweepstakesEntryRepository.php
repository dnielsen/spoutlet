<?php

namespace Platformd\SweepstakesBundle\Entity;

use Doctrine\ORM\EntityRepository;
use Platformd\SweepstakesBundle\Entity\Sweepstakes;
use Platformd\UserBundle\Entity\User;

/**
 * SweepstakesEntryRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class SweepstakesEntryRepository extends EntityRepository
{
    public function findOneBySweepstakesAndUser(Sweepstakes $sweepstakes, User $user)
    {
        $res = $this->createQueryBuilder('e')
            ->andWhere('e.sweepstakes = :sweepstakes')
            ->andWhere('e.user = :user')
            ->setParameters(array(
                'user' => $user,
                'sweepstakes' => $sweepstakes,
            ))
            ->getQuery()
            ->setMaxResults(1)
            ->getOneOrNullResult()
        ;

        return $res;
    }

    public function findOneByIdAndUser($id, User $user)
    {
        return $this
            ->createQueryBuilder('e')
            ->where('e.user = :user')
            ->andWhere('e.id = :id')
            ->setParameters(array(
                'id'    => $id,
                'user'  => $user,
            ))
            ->getQuery()
            ->getOneOrNullResult();
    }

    public function findAllOrderedByNewest(Sweepstakes $sweepstakes)
    {
        return $this->createQueryBuilder('e')
            ->addSelect('u.username')
            ->addSelect('u.id')
            ->addSelect('u.firstname')
            ->addSelect('u.lastname')
            ->addSelect('u.email')
            ->addSelect('u.birthdate')
            ->addSelect('c.name')
            ->addSelect('u.state')
            ->addSelect('u.created')
            ->addSelect('u.lastLogin')
            ->addSelect('e.ipAddress')
            ->addSelect('e.createdAccount')
            ->addSelect('e.phoneNumber')
            ->addSelect('a')
            ->leftJoin('e.country', 'c')
            ->leftJoin('e.user', 'u')
            ->leftJoin('e.answers', 'a')
            ->orderBy('e.created', 'DESC')
            ->andWhere('e.sweepstakes = :sweepstakes')
            ->setParameter('sweepstakes', $sweepstakes)
            ->getQuery()->setFetchMode('SweepstakesEntry', 'answers', 'EAGER')
            ->getArrayResult();
        ;
    }

    public function findAllForRegionOrderedByNewest(Sweepstakes $sweepstakes, $regionId)
    {
        return $this->createQueryBuilder('e')
            ->addSelect('u.username')
            ->addSelect('u.id')
            ->addSelect('u.firstname')
            ->addSelect('u.lastname')
            ->addSelect('u.email')
            ->addSelect('u.birthdate')
            ->addSelect('c.name')
            ->addSelect('u.state')
            ->addSelect('u.created')
            ->addSelect('u.lastLogin')
            ->addSelect('e.ipAddress')
            ->addSelect('e.createdAccount')
            ->addSelect('e.phoneNumber')
            ->addSelect('a')
            ->leftJoin('e.country', 'c')
            ->leftJoin('e.user', 'u')
            ->leftJoin('e.answers', 'a')
            ->leftJoin('c.regions', 'r')
            ->orderBy('e.created', 'DESC')
            ->andWhere('e.sweepstakes = :sweepstakes')
            ->andWhere('r.id = :regionId')
            ->setParameter('sweepstakes', $sweepstakes)
            ->setParameter('regionId', $regionId)
            ->getQuery()->setFetchMode('SweepstakesEntry', 'answers', 'EAGER')
            ->getArrayResult();
        ;
    }

    public function findAllWithoutRegionOrderedByNewest(Sweepstakes $sweepstakes)
    {
        return $this->createQueryBuilder('e')
            ->addSelect('u.username')
            ->addSelect('u.id')
            ->addSelect('u.firstname')
            ->addSelect('u.lastname')
            ->addSelect('u.email')
            ->addSelect('u.birthdate')
            ->addSelect('c.name')
            ->addSelect('u.state')
            ->addSelect('u.created')
            ->addSelect('u.lastLogin')
            ->addSelect('e.ipAddress')
            ->addSelect('e.createdAccount')
            ->addSelect('e.phoneNumber')
            ->addSelect('a')
            ->leftJoin('e.country', 'c')
            ->leftJoin('e.user', 'u')
            ->leftJoin('e.answers', 'a')
            ->leftJoin('c.regions', 'r')
            ->orderBy('e.created', 'DESC')
            ->andWhere('e.sweepstakes = :sweepstakes')
            ->andWhere('r.id IS NULL')
            ->setParameter('sweepstakes', $sweepstakes)
            ->getQuery()->setFetchMode('SweepstakesEntry', 'answers', 'EAGER')
            ->getArrayResult();
        ;
    }

    public function getTotalEntryCounts($site = null)
    {
        $qb  = $this->createQueryBuilder('e')
            ->select('COUNT(e.id) AS entryCount', 'ss.id AS sweepstakesId', 'ss.name AS sweepstakesName')
            ->leftJoin('e.sweepstakes','ss')
            ->addGroupBy('ss.id');

        if ($site) {
            $qb->leftJoin('ss.sites', 's')
                ->andWhere('s = :site')
                ->setParameter('site', $site);
        }

        return $qb->getQuery()
            ->getResult();
    }

    public function getRegionCounts($site = null)
    {
        $qb  = $this->createQueryBuilder('e')
            ->select('COUNT(e.id) AS entryCount', 'ss.id AS sweepstakesId', 'ss.name AS sweepstakesName', 'r.name AS regionName')
            ->leftJoin('e.sweepstakes','ss')
            ->leftJoin('e.country', 'c')
            ->leftJoin('c.regions', 'r')
            ->andWhere('r.isMetricsRegion = true')
            ->addGroupBy('r.name')
            ->addGroupBy('ss.name');

        if ($site) {
            $qb->leftJoin('ss.sites', 's')
                ->andWhere('s = :site')
                ->setParameter('site', $site);
        }

        return $qb->getQuery()
            ->getResult();
    }
}
