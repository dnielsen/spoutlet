<?php

namespace Application\Migrations;

use Doctrine\DBAL\Migrations\AbstractMigration,
    Doctrine\DBAL\Schema\Schema;

/**
 * Auto-generated Migration: Please modify to your need!
 */
class Version20130412131737 extends AbstractMigration
{
    public function up(Schema $schema)
    {
        // this up() migration is autogenerated, please modify it to your needs
        $this->abortIf($this->connection->getDatabasePlatform()->getName() != "mysql");

        $this->addSql("CREATE TABLE pd_giveaway (id INT AUTO_INCREMENT NOT NULL, game_id INT DEFAULT NULL, ruleset_id INT DEFAULT NULL, name VARCHAR(255) NOT NULL, slug VARCHAR(255) NOT NULL, ready TINYINT(1) NOT NULL, published TINYINT(1) NOT NULL, content LONGTEXT DEFAULT NULL, locale VARCHAR(10) DEFAULT NULL, bannerImage VARCHAR(255) DEFAULT NULL, created DATETIME NOT NULL, updated DATETIME NOT NULL, starts_at DATETIME DEFAULT NULL, ends_at DATETIME DEFAULT NULL, generalImage VARCHAR(255) DEFAULT NULL, timezone VARCHAR(255) NOT NULL, external_url VARCHAR(255) DEFAULT NULL, display_timezone TINYINT(1) NOT NULL, test_only TINYINT(1) DEFAULT NULL, redemptionInstructions LONGTEXT NOT NULL, status VARCHAR(15) NOT NULL, giveawayType VARCHAR(30) NOT NULL, displayRemainingKeysNumber TINYINT(1) NOT NULL, INDEX IDX_2FF0020AE48FD905 (game_id), UNIQUE INDEX UNIQ_2FF0020A54F1C144 (ruleset_id), UNIQUE INDEX slug_unique (slug), PRIMARY KEY(id)) ENGINE = InnoDB");
        $this->addSql("CREATE TABLE pd_giveaway_site (giveaway_id INT NOT NULL, site_id INT NOT NULL, INDEX IDX_7307E26834ABDE8C (giveaway_id), INDEX IDX_7307E268F6BD1646 (site_id), PRIMARY KEY(giveaway_id, site_id)) ENGINE = InnoDB");
        $this->addSql("ALTER TABLE pd_giveaway ADD CONSTRAINT FK_2FF0020AE48FD905 FOREIGN KEY (game_id) REFERENCES pd_game(id) ON DELETE SET NULL");
        $this->addSql("ALTER TABLE pd_giveaway ADD CONSTRAINT FK_2FF0020A54F1C144 FOREIGN KEY (ruleset_id) REFERENCES pd_country_age_restriction_ruleset(id)");
        $this->addSql("ALTER TABLE pd_giveaway_site ADD CONSTRAINT FK_7307E26834ABDE8C FOREIGN KEY (giveaway_id) REFERENCES pd_giveaway(id) ON DELETE CASCADE");
        $this->addSql("ALTER TABLE pd_giveaway_site ADD CONSTRAINT FK_7307E268F6BD1646 FOREIGN KEY (site_id) REFERENCES pd_site(id) ON DELETE CASCADE");
        $this->addSql('INSERT IGNORE INTO pd_giveaway (`id`, `name`, `slug`, `ready`, `published`, `starts_at`, `ends_at`, `content`, `locale`, `bannerImage`, `redemptionInstructions`, `status`, `created`, `updated`, `generalImage`, `timezone`, `giveawayType`, `game_id`, `external_url`, `display_timezone`, `ruleset_id`, `displayRemainingKeysNumber`, `test_only` ) SELECT `id`, `name`, `slug`, `ready`, `published`, `starts_at`, `ends_at`, `content`, `locale`, `bannerImage`, `redemptionInstructions`, `status`, `created`, `updated`, `generalImage`, `timezone`, `giveawayType`, `game_id`, `external_url`, `display_timezone`, `ruleset_id`, `displayRemainingKeysNumber`, `test_only` FROM event WHERE `discr`="giveaway";');
        $this->addSql('INSERT IGNORE INTO pd_giveaway_site (`giveaway_id`, `site_id`) SELECT `abstractevent_id`, `site_id` FROM pd_event_site WHERE `abstractevent_id` IN (SELECT `id` FROM event WHERE `discr` = "giveaway")');
        $this->addSql("ALTER TABLE event DROP redemptionInstructions, DROP status, DROP giveawayType, DROP displayRemainingKeysNumber");
    }

    public function down(Schema $schema)
    {
        // this down() migration is autogenerated, please modify it to your needs
        $this->abortIf($this->connection->getDatabasePlatform()->getName() != "mysql");

        $this->addSql("ALTER TABLE pd_giveaway_site DROP FOREIGN KEY FK_7307E26834ABDE8C");
        $this->addSql("ALTER TABLE pd_machine_code_entry DROP FOREIGN KEY FK_C13FB63634ABDE8C");
        $this->addSql("ALTER TABLE giveaway_pool DROP FOREIGN KEY FK_30A1A32F34ABDE8C");
        $this->addSql("DROP TABLE pd_giveaway");
        $this->addSql("DROP TABLE pd_giveaway_site");
        $this->addSql("ALTER TABLE event ADD redemptionInstructions LONGTEXT DEFAULT NULL, ADD status VARCHAR(15) DEFAULT NULL, ADD giveawayType VARCHAR(30) DEFAULT NULL, ADD displayRemainingKeysNumber TINYINT(1) DEFAULT NULL");
    }
}
