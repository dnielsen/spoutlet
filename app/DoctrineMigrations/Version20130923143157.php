<?php

namespace Application\Migrations;

use Doctrine\DBAL\Migrations\AbstractMigration,
    Doctrine\DBAL\Schema\Schema;

/**
 * Auto-generated Migration: Please modify to your need!
 */
class Version20130923143157 extends AbstractMigration
{
    public function up(Schema $schema)
    {
        // this up() migration is autogenerated, please modify it to your needs
        $this->abortIf($this->connection->getDatabasePlatform()->getName() != "mysql");

        $this->addSql("CREATE TABLE promo_code_contest_winning_code (id INT AUTO_INCREMENT NOT NULL, contest_id INT DEFAULT NULL, user INT DEFAULT NULL, country_id INT DEFAULT NULL, value VARCHAR(255) NOT NULL, assigned_at DATETIME DEFAULT NULL, assigned_site VARCHAR(10) DEFAULT NULL, ip_address VARCHAR(100) DEFAULT NULL, INDEX IDX_C36AC5091CD0F0DE (contest_id), INDEX IDX_C36AC5098D93D649 (user), INDEX IDX_C36AC509F92F3E70 (country_id), PRIMARY KEY(id)) ENGINE = InnoDB");
        $this->addSql("CREATE TABLE promo_code_contest_consolation_code (id INT AUTO_INCREMENT NOT NULL, contest_id INT DEFAULT NULL, user INT DEFAULT NULL, country_id INT DEFAULT NULL, value VARCHAR(255) NOT NULL, assigned_at DATETIME DEFAULT NULL, assigned_site VARCHAR(10) DEFAULT NULL, ip_address VARCHAR(100) DEFAULT NULL, PRIMARY KEY(id)) ENGINE = InnoDB");
        $this->addSql("ALTER TABLE promo_code_contest_winning_code ADD CONSTRAINT FK_C36AC5091CD0F0DE FOREIGN KEY (contest_id) REFERENCES pd_sweepstakes(id) ON DELETE CASCADE");
        $this->addSql("ALTER TABLE promo_code_contest_winning_code ADD CONSTRAINT FK_C36AC5098D93D649 FOREIGN KEY (user) REFERENCES fos_user(id) ON DELETE CASCADE");
        $this->addSql("ALTER TABLE promo_code_contest_winning_code ADD CONSTRAINT FK_C36AC509F92F3E70 FOREIGN KEY (country_id) REFERENCES country(id)");
        $this->addSql("ALTER TABLE promo_code_contest_consolation_code ADD CONSTRAINT FK_82E0B4401CD0F0DE FOREIGN KEY (contest_id) REFERENCES pd_sweepstakes(id) ON DELETE CASCADE");
        $this->addSql("ALTER TABLE promo_code_contest_consolation_code ADD CONSTRAINT FK_82E0B4408D93D649 FOREIGN KEY (user) REFERENCES fos_user(id) ON DELETE CASCADE");
        $this->addSql("ALTER TABLE promo_code_contest_consolation_code ADD CONSTRAINT FK_82E0B440F92F3E70 FOREIGN KEY (country_id) REFERENCES country(id)");
        $this->addSql("ALTER TABLE pd_sweepstakes ADD event_type VARCHAR(20) NOT NULL");

        $this->addSql("ALTER TABLE pd_sweepstakes ADD affidavit_id INT DEFAULT NULL, ADD w9form_id INT DEFAULT NULL");
        $this->addSql("ALTER TABLE pd_sweepstakes ADD CONSTRAINT FK_3DC99D982AD3B6E7 FOREIGN KEY (w9form_id) REFERENCES pd_media(id) ON DELETE SET NULL");
        $this->addSql("ALTER TABLE pd_sweepstakes ADD CONSTRAINT FK_3DC99D98AAC662BA FOREIGN KEY (affidavit_id) REFERENCES pd_media(id) ON DELETE SET NULL");
        $this->addSql("CREATE UNIQUE INDEX UNIQ_3DC99D98AAC662BA ON pd_sweepstakes (affidavit_id)");
        $this->addSql("CREATE UNIQUE INDEX UNIQ_3DC99D982AD3B6E7 ON pd_sweepstakes (w9form_id)");

        $this->addSql("CREATE INDEX event_type_idx ON pd_sweepstakes (event_type)");
        $this->addSql("ALTER TABLE pd_sweepstakes_entry ADD created_account TINYINT(1) NOT NULL");
        $this->addSql("UPDATE pd_sweepstakes SET event_type='sweepstakes' WHERE id > 0");
    }

    public function down(Schema $schema)
    {
        // this down() migration is autogenerated, please modify it to your needs
        $this->abortIf($this->connection->getDatabasePlatform()->getName() != "mysql");

        $this->addSql("ALTER TABLE pd_sweepstakes_entry DROP created_account");
        $this->addSql("DROP TABLE promo_code_contest_winning_code");
        $this->addSql("DROP TABLE promo_code_contest_consolation_code");
        $this->addSql("DROP INDEX event_type_idx ON pd_sweepstakes");
        $this->addSql("ALTER TABLE pd_sweepstakes DROP event_type");

    }
}
